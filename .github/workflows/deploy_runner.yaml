name: Run Playwright Runner Installation

#on:
#  workflow_dispatch:
#    inputs:
#      pipeline_branch:
#        description: 'Test pipeline branch name'
#        type: string
#        required: true
#        default: 'main'

on:
  push:
    branches-ignore:
      - "**release*"
      - "prettier/**"
      - "dependabot/**"
    paths-ignore:
      - "docs/**"
      - "README.md"
      - ".github/**"
  workflow_dispatch: {}
  pull_request:
    branches: [main]
    types:
      [opened, reopened, synchronize]

permissions: {}


jobs:
  Clean_Install_Environments:
    runs-on: ubuntu-latest
    name: Clean Install
    steps:
      - name: Get current workflow branch
        id: get_branch
        run: |
      - name: Checkout pipeline
        uses: actions/checkout@v4
        with:
          ref: 'main'
          repository: 'Netcracker/qubership-test-pipelines'
          path: 'qubership-test-pipelines'
      - name: Create Kubernetes Cluster
        uses: ./qubership-test-pipelines/actions/shared/create_cluster

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Listing downloaded files
        run: |
          pwd
          ls -R ./

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.32.0'

#      - name: Setup Helm
#        uses: azure/setup-helm@v3

      - name: Verify tools
        run: |
          kubectl version --client
          helm version
          kubectl create ns playwright-runner
          kubectl get namespaces

      - name: Install Playwright Runner
        run: |
          ls -l
          helm install --namespace=playwright-runner --create-namespace -f ./deployments/charts/atp3-playwright-runner/values.yaml -f ./deployments/charts/atp3-playwright-runner/resource-profiles/dev.yaml atp3-playwright-runner ./deployments/charts/atp3-playwright-runner --set DOCKER_TAG="ghcr.io/netcracker/qubership-testing-platform-playwright-runner:build_process_latest"

      - name: Get docker images
        shell: bash
        run: |
          # ▶️ Get docker images
          sleep  15s
          kubectl get pods -n playwright-runner
          kubectl get pods -n playwright-runner -o go-template --template="{{range .items}}{{range .spec.containers}}{{.image}} {{end}}{{end}}"